import fs from "node:fs";
import { join } from "node:path";
import lighthouse from "lighthouse";
import minimist from "minimist";
(async () => {
  const { routeReport, port, lighthouseOptions: lighthouseOptionsEncoded } = minimist(process.argv.slice(2));
  const routeReportJson = JSON.parse(routeReport);
  const lighthouseOptions = {
    ...JSON.parse(lighthouseOptionsEncoded),
    // always generate html / json reports
    output: ["html", "json"],
    // we tell lighthouse the port
    port
  };
  try {
    const runnerResult = await lighthouse(routeReportJson.route.url, lighthouseOptions);
    fs.writeFileSync(join(routeReportJson.artifactPath, "lighthouse.json"), runnerResult.report[1]);
    fs.writeFileSync(join(routeReportJson.artifactPath, "lighthouse.html"), runnerResult.report[0]);
    return true;
  } catch (e) {
    console.error(e);
  }
  return false;
})();
