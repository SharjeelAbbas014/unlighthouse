import { createUnlighthouse, useLogger } from '@unlighthouse/core';
import { createServer } from '@unlighthouse/server';
import open from 'better-opn';
import { c as createCli, p as pickOptions, v as validateHost, a as validateOptions } from './shared/cli.ecaed16a.mjs';
import 'node:url';
import 'lodash-es';
import 'defu';
import 'consola';
import 'cac';

const cli = createCli();
const { options } = cli.parse();
async function run() {
  const start = /* @__PURE__ */ new Date();
  if (options.help || options.version)
    return;
  const unlighthouse = await createUnlighthouse(
    {
      ...pickOptions(options),
      hooks: {
        "resolved-config": async (config) => {
          await validateHost(config);
        }
      }
    },
    { name: "cli" }
  );
  validateOptions(unlighthouse.resolvedConfig);
  const { server, app } = await createServer();
  await unlighthouse.setServerContext({ url: server.url, server: server.server, app });
  await unlighthouse.start();
  unlighthouse.hooks.hook("worker-finished", () => {
    const end = /* @__PURE__ */ new Date();
    const seconds = Math.round((end.getTime() - start.getTime()) / 1e3);
    const logger = useLogger();
    logger.success(`Unlighthouse has finished scanning \`${unlighthouse.resolvedConfig.site}\`: ${unlighthouse.worker.reports().length} routes in \`${seconds}s\`.`);
  });
  if (unlighthouse.resolvedConfig.server.open)
    await open(unlighthouse.runtimeSettings.clientUrl);
}
run();
